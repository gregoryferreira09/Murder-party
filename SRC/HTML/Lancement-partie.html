<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Choix du personnage - Murder Party</title>
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <link rel="stylesheet" href="../../Public/styles/style.css">
  <style>
    /* Accessibilité et exceptions spécifiques */
    .a11y-visually-hidden {
      position: absolute;
      left: -9999px;
      width: 1px;
      height: 1px;
      overflow: hidden;
    }
  </style>
</head>
<body>
  <header>
    <h1>Choisissez votre personnage</h1>
    <div id="desc" class="a11y-visually-hidden">Liste de personnages à choisir, un seul disponible par joueur.</div>
  </header>
  <main>
    <div class="center-wrapper">
      <section class="main-accueil">
        <div id="personnages-list" role="list" aria-labelledby="desc"></div>
        <div class="boutons-actions">
          <button class="main-btn" id="valider-choix" disabled>Valider mon personnage</button>
        </div>
        <div id="message" aria-live="polite" style="margin-top:15px;"></div>
      </section>
    </div>
  </main>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <script>
    // --- Firebase config ---
    const firebaseConfig = {
      apiKey: "AIzaSyD-BxBu-4ElCqbHrZPM-4-6yf1-yWnL1bI",
      authDomain: "murder-party-ba8d1.firebaseapp.com",
      databaseURL: "https://murder-party-ba8d1-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "murder-party-ba8d1",
      storageBucket: "murder-party-ba8d1.appspot.com",
      messagingSenderId: "20295055805",
      appId: "1:20295055805:web:0963719c3f23ab7752fad4"
    };
    if (!firebase.apps.length) {
      firebase.initializeApp(firebaseConfig);
    }
    const db = firebase.database();

    // --- Récupération infos joueur ---
    const salonCode = localStorage.getItem("salonCode");
    let uuid = localStorage.getItem("uuid");
    if (!uuid) {
      uuid = ([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g, c =>
        (c ^ crypto.getRandomValues(new Uint8Array(1))[0] & 15 >> c / 4).toString(16)
      );
      localStorage.setItem("uuid", uuid);
    }
    let pseudo = localStorage.getItem("pseudo") || "Anonyme";

    // --- Affichage liste perso (avec avatar harmonisé) ---
    let personnages = [];
    let personnageSelectionne = null;
    let valids = {};

    function afficherPersonnages() {
      const listDiv = document.getElementById("personnages-list");
      listDiv.innerHTML = "";
      personnages.forEach(perso => {
        const div = document.createElement("div");
        div.className = "carte-personnage";
        div.setAttribute("role", "listitem");
        div.setAttribute("tabindex", "0");
        div.setAttribute("aria-label", `${perso.nom} - ${perso.description || ""}`);
        div.setAttribute("data-id", perso.id);

        // Avatar affiché à gauche, texte à droite
        div.innerHTML = `
          <div class="carte-personnage-avatarzone">
            <img class="carte-personnage-avatar" src="${perso.image || 'Public/images/personnage1.png'}" alt="Avatar de ${perso.nom}">
          </div>
          <div class="carte-personnage-infos">
            <strong>${perso.nom}</strong>
            <span class="pris-label" style="display:none">Pris</span>
            <div class="carte-personnage-role">${perso.role || ""}</div>
            <div class="carte-personnage-desc">${perso.description || ""}</div>
          </div>
        `;
        // Sélection par clavier ou clic
        div.addEventListener("keydown", e => {
          if (e.key === "Enter" || e.key === " ") div.click();
        });
        div.addEventListener("click", () => {
          if (div.classList.contains("indisponible")) return;
          document.querySelectorAll('.carte-personnage').forEach(card => card.style.border = "2px solid #e0c185");
          div.style.border = "2px solid #4CAF50";
          personnageSelectionne = perso.id;
          localStorage.setItem("personnageSelectionne", personnageSelectionne);
          document.getElementById("valider-choix").disabled = false;
        });
        listDiv.appendChild(div);
      });
      majDisponibilite();
    }

    function majDisponibilite() {
      Object.keys(valids).forEach(joueurUUID => {
        const pid = valids[joueurUUID].personnageId;
        document.querySelectorAll('.carte-personnage').forEach(div => {
          if (div.getAttribute('data-id') == pid && joueurUUID !== uuid) {
            div.classList.add("indisponible");
            div.querySelector('.pris-label').style.display = "inline-block";
          }
          if (div.getAttribute('data-id') == pid && joueurUUID === uuid) {
            div.classList.remove("indisponible");
            div.querySelector('.pris-label').style.display = "none";
          }
        });
      });
    }

    // --- Sync temps réel validation ---
    function startRealtimeSync() {
      db.ref('parties/' + salonCode + '/validations').on('value', snap => {
        valids = snap.val() || {};
        majDisponibilite();
        const nbValid = Object.keys(valids).length;
        const btn = document.getElementById('valider-choix');
        btn.textContent = (valids[uuid] ? 'En attente des autres joueurs (' : '') +
                          nbValid + '/' + personnages.length +
                          (valids[uuid] ? ')' : ' Valider mon personnage');
        if(nbValid === personnages.length) {
          window.location.href = "gameplay.html";
        }
      });
    }

    document.getElementById("valider-choix").onclick = async function() {
      if (!personnageSelectionne || this.disabled) return;
      if (Object.values(valids).some(v => v.personnageId === personnageSelectionne && v.uuid !== uuid)) {
        document.getElementById("message").textContent = "Ce personnage vient d'être pris !";
        return;
      }
      await db.ref('parties/' + salonCode + '/validations/' + uuid).set({
        uuid,
        pseudo,
        personnageId: personnageSelectionne
      });
      document.getElementById("valider-choix").disabled = true;
      document.getElementById("message").textContent = "Choix validé, en attente...";
    };

    // --- Récupère la liste des personnages depuis la base ---
    async function chargerPersonnages() {
      const persosSnap = await db.ref('parties/' + salonCode + '/personnages').get();
      personnages = [];
      persosSnap.forEach(snap => {
        personnages.push({ ...snap.val(), id: snap.key });
      });
      afficherPersonnages();
      startRealtimeSync();
    }

    // --- Init page ---
    document.addEventListener("DOMContentLoaded", async function() {
      if (!salonCode) {
        document.getElementById("message").textContent = "Aucun salon trouvé.";
        return;
      }
      await chargerPersonnages();
    });
  </script>
</body>
</html>
