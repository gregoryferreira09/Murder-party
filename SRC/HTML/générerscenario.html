<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Scénario de Murder Party</title>
  <style>
    body { font-family: Arial, sans-serif; background: #222; color: #f8eecb; }
    .container { max-width: 700px; margin: 40px auto; background: #412; padding: 2em; border-radius: 12px; }
    h1 { text-align: center; }
    .btn { background: gold; color: #412; border: none; padding: 12px 24px; font-size: 1.2em; border-radius: 8px; cursor: pointer; display: block; margin: 20px auto; }
    .scenario-block { margin: 1.5em 0; }
    .roles { margin: 1em 0 2em 0; }
    .role { margin-bottom: 0.8em; }
    .victime { color: #e57373; font-weight: bold; }
    .criminel { color: #d4af37; font-weight: bold; }
  </style>
</head>
<body>
<div class="container">
  <h1>Votre scénario sur mesure</h1>
  
  <form id="paramsForm">
    <label>Époque :
      <select id="epoque">
        <option value="medieval">Moyen-Âge</option>
        <option value="renaissance">Renaissance</option>
        <option value="victorien">Victorien</option>
        <option value="western">Western</option>
        <option value="contemporain">Contemporain</option>
        <option value="futuriste">Futuriste</option>
        <option value="historique">Historique</option>
      </select>
    </label>
    <label>Joueurs : <input type="number" id="joueurs" min="4" max="12" value="6"></label>
    <label>Criminels : <input type="number" id="criminels" min="1" max="3" value="1"></label>
    <button type="submit" class="btn">Générer le scénario</button>
  </form>

  <div id="scenario"></div>
</div>

<script type="module">
import univers from '../SRC/JS/univers.js';

function sample(arr, n = 1) {
  arr = [...arr];
  const res = [];
  for (let i = 0; i < n; i++) {
    if (arr.length === 0) break;
    const idx = Math.floor(Math.random() * arr.length);
    res.push(arr.splice(idx, 1)[0]);
  }
  return n === 1 ? res[0] : res;
}

function genererScenario(epoque, nbJoueurs, nbCriminels) {
  const data = univers[epoque];
  if (!data) return { erreur: "Époque non supportée." };

  const joueurs = sample(data.personnages, nbJoueurs);
  const criminels = sample(joueurs, nbCriminels);
  const suspects = joueurs.filter(p => !criminels.includes(p));
  const victime = sample(suspects);

  const roles = joueurs.map(nom => ({
    nom,
    role: nom === victime ? 'victime' : (criminels.includes(nom) ? 'criminel' : 'innocent'),
    alibi: sample(data.alibis),
    secret: sample(data.secrets),
    lien: sample(data.liensAvecVictime)
  }));

  const lieuCrime = sample(data.lieux);
  const armesPossibles = data.armes[lieuCrime.nom] || [];
  const armeCrime = sample(armesPossibles);
  const mobile = sample(data.mobiles);
  const ambiance = sample(data.ambiances);
  const introBrute = sample(data.intro);
  const intro = introBrute
    .replace('{ambiance}', ambiance)
    .replace('{la_lieu}', lieuCrime.nom)
    .replace('{suspect1}', criminels[0] || '')
    .replace('{suspect2}', criminels[1] || '')
    .replace('{motif}', mobile)
    .replace('{indice}', sample(data.indices))
    .replace('{temoin}', sample(joueurs.filter(n => n !== criminels[0])));

  const indices = sample(data.indices, Math.min(4, data.indices.length));

  return {
    epoque,
    ambiance,
    intro,
    lieuCrime,
    armeCrime,
    mobile,
    roles,
    indices
  };
}

function afficherScenario(scenario) {
  if (scenario.erreur) {
    document.getElementById('scenario').innerHTML = `<p>${scenario.erreur}</p>`;
    return;
  }
  let html = `
    <div class="scenario-block"><strong>Époque :</strong> ${scenario.epoque}</div>
    <div class="scenario-block"><strong>Ambiance :</strong> ${scenario.ambiance}</div>
    <div class="scenario-block"><strong>Introduction :</strong> <br>${scenario.intro}</div>
    <div class="scenario-block"><strong>Lieu du crime :</strong> ${scenario.lieuCrime.nom}</div>
    <div class="scenario-block"><strong>Arme du crime :</strong> ${scenario.armeCrime?.nom || '???'}</div>
    <div class="scenario-block"><strong>Mobile :</strong> ${scenario.mobile}</div>
    <div class="roles"><strong>Rôles des joueurs :</strong>`;
  scenario.roles.forEach(r => {
    html += `<div class="role ${r.role}">
      <span>${r.nom} — <b>${r.role.toUpperCase()}</b><br>
      <em>Alibi :</em> ${r.alibi}<br>
      <em>Secret :</em> ${r.secret}<br>
      <em>Lien avec la victime :</em> ${r.lien}
      </span>
    </div>`;
  });
  html += `</div>
    <div class="scenario-block"><strong>Indices à disposition :</strong><ul>`;
  scenario.indices.forEach(i => html += `<li>${i}</li>`);
  html += '</ul></div>';
  document.getElementById('scenario').innerHTML = html;
}

document.getElementById('paramsForm').addEventListener('submit', function(e) {
  e.preventDefault();
  const epoque = document.getElementById('epoque').value;
  const joueurs = parseInt(document.getElementById('joueurs').value, 10);
  const criminels = parseInt(document.getElementById('criminels').value, 10);
  const scenario = genererScenario(epoque, joueurs, criminels);
  afficherScenario(scenario);
});

// Génération initiale
window.addEventListener('DOMContentLoaded', () => {
  const scenario = genererScenario('medieval', 6, 1);
  afficherScenario(scenario);
});
</script>
</body>
</html>
