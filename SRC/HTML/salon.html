<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Salon d'attente – Murder Party</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="../../Public/styles/style.css">
  <link href="https://fonts.googleapis.com/css2?family=Cinzel+Decorative&family=Cormorant+Garamond&display=swap" rel="stylesheet">
  <style>
    /* ... styles identiques à ta version précédente ... */
  </style>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
</head>
<body>
  <header>
    <h1 class="salon-titre">Salon d'attente</h1>
  </header>
  <div class="center-wrapper">
    <main>
      <section class="salon-container" aria-labelledby="salon-heading">
        <div class="code-salon">
          Code du salon : <span id="codeSalon"></span>
        </div>
        <div style="width:100%;">
          <strong>Joueurs connectés :</strong>
          <ul class="joueurs-liste" id="joueursListe">
            <li>Chargement...</li>
          </ul>
        </div>
        <button class="demarrer-btn" id="demarrerBtn" disabled style="display:none;">En attente...</button>
        <div class="infoSalon" id="infoSalon"></div>
        <a href="#" class="quit-link" id="quitSalonBtn">Quitter le salon</a>
      </section>
    </main>
  </div>
  <footer class="footer">
    <p>© 2025 Murder Party. Tous droits réservés.</p>
    <a href="mentions-legales.html">Mentions légales</a>
  </footer>
  <script>
    // --- Firebase config ---
    const firebaseConfig = {
      apiKey: "AIzaSyD-BxBu-4ElCqbHrZPM-4-6yf1-yWnL1bI",
      authDomain: "murder-party-ba8d1.firebaseapp.com",
      databaseURL: "https://murder-party-ba8d1-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "murder-party-ba8d1",
      storageBucket: "murder-party-ba8d1.appspot.com",
      messagingSenderId: "20295055805",
      appId: "1:20295055805:web:0963719c3f23ab7752fad4",
      measurementId: "G-KSBMBB7KMJ"
    };
    if (typeof firebase !== "undefined" && !firebase.apps.length) {
      firebase.initializeApp(firebaseConfig);
    }
    const db = firebase.database();

    // --- Récupérer le code salon et l'afficher ---
    const codeSalon = localStorage.getItem("salonCode") || "";
    document.getElementById("codeSalon").textContent = codeSalon;

    // --- Sélection des éléments ---
    const joueursListe = document.getElementById("joueursListe");
    const btnDemarrer = document.getElementById("demarrerBtn");
    const infoSalon = document.getElementById("infoSalon");
    const quitSalonBtn = document.getElementById("quitSalonBtn");

    let nombreJoueursAttendus = 0;
    let estCreateur = false;
    let pseudo = localStorage.getItem("pseudo") || "";
    let uuid = localStorage.getItem("uuid") || "";

    if (!codeSalon) {
      window.location.href = "accueil.html";
    } else {
      // Récupérer le créateur et le nombre de joueurs attendus
      Promise.all([
        db.ref('parties/' + codeSalon + '/parametres/createur').get(),
        db.ref('parties/' + codeSalon + '/parametres/nombreJoueurs').get()
      ]).then(([snapCreateur, snapNbJoueurs]) => {
        const uuidCreateur = snapCreateur.exists() ? snapCreateur.val().uuid : null;
        nombreJoueursAttendus = snapNbJoueurs.exists() ? parseInt(snapNbJoueurs.val()) : 0;
        estCreateur = uuidCreateur && uuidCreateur === uuid;

        // Afficher le bouton Démarrer uniquement pour le créateur
        btnDemarrer.style.display = estCreateur ? "" : "none";

        // Gestion de la liste des joueurs en temps réel
        db.ref('parties/' + codeSalon + '/joueurs').on('value', snapshot => {
          joueursListe.innerHTML = "";
          const joueurs = [];
          snapshot.forEach(childSnap => {
            joueurs.push(childSnap.val().pseudo || "???");
          });

          // Mise à jour du compteur
          const compteurTxt = `${joueurs.length} / ${nombreJoueursAttendus} maximum`;
          infoSalon.textContent = `En attente de joueurs... (${compteurTxt})`;

          if (joueurs.length === 0) {
            joueursListe.innerHTML = "<li>Aucun joueur encore connecté.</li>";
            if (estCreateur) {
              btnDemarrer.disabled = true;
              btnDemarrer.textContent = "En attente...";
              btnDemarrer.classList.add("desactive");
            }
          } else {
            joueurs.forEach(pseudo => {
              const li = document.createElement("li");
              li.textContent = pseudo;
              joueursListe.appendChild(li);
            });

            if (estCreateur) {
              if (nombreJoueursAttendus && joueurs.length === nombreJoueursAttendus) {
                btnDemarrer.disabled = false;
                btnDemarrer.textContent = "Démarrer la partie";
                btnDemarrer.classList.remove("desactive");
              } else {
                btnDemarrer.disabled = true;
                btnDemarrer.textContent = "En attente...";
                btnDemarrer.classList.add("desactive");
              }
            }
          }
        });

        // --- Gestion du démarrage de la partie ---
        // On écoute la valeur "partieLancee" dans la BDD (pour tous les joueurs)
        db.ref('parties/' + codeSalon + '/partieLancee').on('value', (snap) => {
          if (snap.exists() && snap.val() === true) {
            window.location.href = "lancement-partie.html";
          }
        });

        // --- Gestion de la suppression du salon ---
        // Si le salon est supprimé (le créateur quitte), tous les joueurs sont éjectés
        db.ref('parties/' + codeSalon).on('value', (snap) => {
          if (!snap.exists()) {
            alert("Le salon a été fermé par le créateur.");
            window.location.href = "rejoindre-partie.html";
          }
        });

        // Action du bouton Démarrer (créateur uniquement)
        btnDemarrer.addEventListener("click", function () {
          if (btnDemarrer.disabled) return;
          db.ref('parties/' + codeSalon + '/partieLancee').set(true);
          window.location.href = "lancement-partie.html";
        });

        // Quitter le salon (pour tous)
        quitSalonBtn.addEventListener("click", function(e) {
          e.preventDefault();
          if (estCreateur) {
            // Supprime tout le salon
            db.ref('parties/' + codeSalon).remove().then(() => {
              localStorage.removeItem("salonCode");
              window.location.href = "rejoindre-partie.html";
            });
          } else {
            // Retire juste le joueur
            db.ref('parties/' + codeSalon + '/joueurs').orderByChild('uuid').equalTo(uuid).once("value", snap => {
              snap.forEach(child => child.ref.remove());
              localStorage.removeItem("salonCode");
              window.location.href = "rejoindre-partie.html";
            });
          }
        });
      });
    }
  </script>
</body>
</html>
